
      SUBROUTINE LTNINGI(USOLI,P0CGS)
      
      INCLUDE '../INCLUDECHEM/parNZ.inc' !nz
      INCLUDE '../INCLUDECHEM/parNQ_NQT.inc'!NQ=29 NQT=NQ+1
      
      INCLUDE '../INCLUDECHEM/comBBLOK.inc'!USOL(NQ,NZ),SMFLUX(NQ),SGFLUX(NQ),VDEP(NQ)
      INCLUDE '../INCLUDECHEM/comLTBLOK.inc' ! ZAPNO
      INCLUDE '../INCLUDECHEM/comNBLOK.inc' !L_SPECIES

      COMMON/NIBLOK/LH2CQ,LQ,LH2Q,LQH,LHOQ,LH2OQ,LO2Q,LOQO,LCQ,LCH3OQH,
     2  LCH3QOH,LCH3OQ,LCH3QO,LN2Q,LNQ,LNOQ,LHNOQ,LHNO2Q,
     3  LHOQNO2,LHO2NOQ,
     4  LNO2Q,LN2O4Q,LN2QO4,LOQ,LSQ,LSOQ,LH2SO3Q,LHSQ,LCOQ,LQ1D, 
     5  LH3CQ,LHCQ,LSO1Q,LSO3Q,LHSO2Q,LSO2Q,LIH2CO,LIO,LIH2O,LIOH,
     6  LIHO2,LIH2O2,LIO3,LIH,LIH2,LICH4,LICO,LICH3OOH,LICH3O2,LIN2O,
     7  LINO,LINO2,LIHNO3,LIHO2NO2,LINO3,LIN2O5,LIO2,LIH2S,LIHS,LISO,
     8  LISO2,LIHSO,LIO1D,LICH21,LICH23,LICH3,LIH3CO,LIHCO,LIN,LIS,
     9  LISO21,LISO23,LIHSO3,LISO3,LIN2

      PARAMETER(NQI=29, NQI1=NQI+1, NSLS=36)
      PARAMETER(NRI=319, NSPI=75, NSPI1=NSPI+1, NSPI2=NSPI+2,NMAXI=70)
      DIMENSION USOLI(NQI,NZ)

C     THIS SUBROUTINE CALCULATES LIGHTNING PRODUCTION RATES FOR O2
C     AND NO IN AN N2-O2-CO2-H2O ATMOSPHERE USING THE EQUATIONS IN
C     THESIS APPENDIX C.
C
C     EQUILIBRIUM CONSTANTS AT 3500 K
      AK1 = .103
      AK2 = .619
      AK3 = 5.3
      AK4 = .22
C
      FOQ  = USOLI(LOQ,1) 
      FCOQ = USOLI(LCOQ,1) 
C
      P0 = P0CGS/1.013E6
      FN2 = 1. - FOQ - FCOQ
      PN2 = FN2*P0
      POQ = FOQ*P0
      PCOQ = FCOQ*P0
      PH2Q = USOLI(LH2Q,1)*P0
      PH2 = USOL(LH2,1)*P0
      PCQ = USOLI(LCQ,1)*P0
C
      OQT = POQ + PCOQ + 0.5*(PH2Q + PCQ)
      H2T = PH2 + PH2Q
      CT = PCOQ + PCQ
      ALPHA = AK2*SQRT(OQT)
      BETA = AK3*SQRT(OQT)
      A = (AK1*SQRT(PN2) + AK4)/(2.*SQRT(OQT))
      B = 0.5*CT/OQT
      C = 0.5*H2T/OQT
C
C     INITIAL GUESS FOR XO2 AT 3500 K
      X = 0.1 + 0.9*POQ/OQT + 0.2*PCOQ/OQT
C     NEWTON STEP
      DO 1 N=1,20
      NS = N
      XS = X
      X2 = SQRT(X)
      FX = X + A*X2 - B/(1.+ALPHA*X2) - C/(1.+BETA*X2) + 2.*B + C - 1.
      FPX = 1. + (A + ALPHA*B/(1.+ALPHA*X2)**2 + BETA*C/(1.+BETA*X2)
     2  **2)/(2.*X2)
      X = X - FX/FPX
      ERR = ABS((X-XS)/X)
      IF(ERR.LT.1.E-5) GO TO 2
   1  CONTINUE
   2  POQ = X*OQT
      PNQ = AK1*SQRT(PN2*POQ)
C
C     SCALE AGAINST ESTIMATED COLUMN PRODUCTION OF NO IN THE PRESENT-
C     DAY TROPOSPHERE.  DISTRIBUTE PRODUCTION OVER LOWEST 6 KM.
C
      PRNOX = 3.E9/7.942E5
      PNONOW = 3.574E-2
      ZAPNO = PRNOX*PNQ/PNONOW

c ZAPO2 is only needed in high CO2 atmospheres
c      ZAPO2 = ZAPNO*PO2/PNO
c      write(90,100)PO2,PNO,ZAPO2,ZAPNO
c 100  FORMAT(/1X,'PO2=',1PE10.3,2X,'PNO=',1PE10.3,2X,'ZAPO2=',
c     2  1PE10.3,2X,'ZAPNO=',1PE10.3)
      print 100, POQ,PNQ,ZAPNO
 100  FORMAT(/1X,'POQ=',1PE10.3,2X,'PNQ=',1PE10.3,2X,'ZAPNQ=',1PE10.3)
      print 101, NS,X,ERR
 101  FORMAT(1X,'N=',I2,5X,'X=',1PE12.5,2X,'ERR=',1PE12.5)
      RETURN
      END
C-PL ALREADY HAVE FUNCTION DEFINITION FOR SIGRAY AND E1 IN SUBROUTINE LIGHTNING
!      FUNCTION SIGRAY(W)
!      W1 = 1.E-4 * W
!      W2 = W1 * W1
!      W4 = W2 * W2
!      SIGRAY = 4.006E-28*(1. + .0113/W2 + .00013/W4)/W4
!      RETURN
!      END

!      FUNCTION E1(X)
!      COMMON/EBLOK1/A(6),B(4),C(4)
!      E1 = 0.
!      IF(X.EQ.0.) RETURN
C
!      X2 = X*X
!      X3 = X2*X
!      X4 = X3*X
!      IF(X.GT.1) GO TO 1
!      X5 = X4*X
!      E1 = -ALOG(X) + A(1)*X + A(2)*X2 + A(3)*X3 + A(4)*X4 + A(5)*X5
!     2  + A(6)
!      RETURN
C

!   1  SUM1 = X4 + B(1)*X3 + B(2)*X2 + B(3)*X + B(4)
!      SUM2 = X4 + C(1)*X3 + C(2)*X2 + C(3)*X + C(4)
!      E1 = EXP(-X)*SUM1/SUM2/X
!      RETURN
!      END
